name: Deploy Production

on:
  push:
    branches: [ "production" ] # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —ç—Ç–∞ –≤–µ—Ç–∫–∞

jobs:
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üîê Setup SSH & Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
      script: |
            set -e

            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
            cd ~/backend

            echo "üîß –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í..."
            # !!! –í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é deploy (ID 1000), 
            # —á—Ç–æ–±—ã Git –º–æ–≥ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∫—ç—à–∞.
            # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Docker –æ—Ç —Ä—É—Ç–∞, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å chown
            docker exec -u root app_backend chown -R 1000:1000 /var/www/html

            echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–π –∫–æ–¥..."
            git fetch origin production
            git reset --hard origin/production

            echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            docker exec app_backend composer install --no-dev --optimize-autoloader

            echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
            docker exec app_backend php artisan migrate --force

            echo "üé® –°–æ–±–∏—Ä–∞–µ–º Frontend (Tailwind v4)..."
            docker exec app_backend npm install
            docker exec app_backend npm run build

            echo "üîß –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä—É..."
            # –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ Git –æ—Ç—Ä–∞–±–æ—Ç–∞–ª, –æ—Ç–¥–∞–µ–º –ø—Ä–∞–≤–∞ –æ–±—Ä–∞—Ç–Ω–æ www-data
            docker exec -u root app_backend chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache /var/www/html/public/build
            docker exec -u root app_backend chmod -R 775 /var/www/html/storage

            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ—á–µ—Ä–µ–¥–∏..."
            docker exec app_backend php artisan queue:restart

            echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à..."
            docker exec app_backend php artisan optimize:clear
            docker exec app_backend php artisan view:clear

            echo "‚úÖ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"